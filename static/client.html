<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿¡å‘ç³»ç»Ÿæ˜¾ç¤ºç«¯</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
            color: white;
            font-family: sans-serif;
        }

        #image-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease-in-out;
        }

        #display-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        #fullscreen-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        #fullscreen-prompt h2 {
            margin-bottom: 20px;
            font-size: 28px;
        }

        #fullscreen-prompt p {
            margin-bottom: 30px;
            font-size: 18px;
            color: #666;
        }

        #fullscreen-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #fullscreen-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .welcome-message {
            text-align: center;
            font-size: 24px;
            color: #999;
        }
    </style>
</head>

<body>
    <div id="fullscreen-prompt">
        <h2>ğŸ“º æ¬¢è¿ä½¿ç”¨ä¿¡å‘ç³»ç»Ÿ</h2>
        <p id="device-name-display" style="font-size: 18px; font-weight: bold; color: #444; margin-bottom: 15px;">
            æ­£åœ¨è¿æ¥...</p>
        <p>ä¸ºäº†è·å¾—æœ€ä½³æ˜¾ç¤ºæ•ˆæœï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›å…¥å…¨å±æ¨¡å¼</p>
        <button id="fullscreen-btn" onclick="enterFullscreen()">è¿›å…¥å…¨å±</button>
    </div>

    <div id="image-container">
        <div class="welcome-message" id="welcomeMessage">
            ç­‰å¾…æ¨é€å›¾ç‰‡...
        </div>
        <img id="display-image" src="" alt="æ¨é€å›¾ç‰‡">
    </div>

    <script>
        const API_BASE = window.location.origin; // ä¸åç«¯åŒç«¯å£
        // ç¨³å®šè®¾å¤‡IDï¼šé¦–æ¬¡ç”Ÿæˆå¹¶å­˜å‚¨åœ¨ localStorage
        function getOrCreateDeviceId() {
            const key = 'SIGNAGE_DEVICE_ID';
            let id = localStorage.getItem(key);
            if (!id) {
                id = 'TV-' + Math.random().toString(36).substring(2, 9).toUpperCase();
                localStorage.setItem(key, id);
            }
            return id;
        }
        const DEVICE_ID = getOrCreateDeviceId();
        const HEARTBEAT_INTERVAL = 10000; // 10ç§’å¿ƒè·³
        const POLLING_INTERVAL = 5000; // 5ç§’è½®è¯¢ä»»åŠ¡

        const displayImage = document.getElementById('display-image');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const fullscreenPrompt = document.getElementById('fullscreen-prompt');

        // æ˜¾ç¤ºå…¨å±æç¤ºï¼ˆæ¯æ¬¡æœªå…¨å±æ—¶éƒ½æç¤ºï¼‰
        function showFullscreenPrompt() {
            fullscreenPrompt.style.display = 'block';
        }

        // è¿›å…¥å…¨å±
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
            fullscreenPrompt.style.display = 'none';
        }

        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                // é€€å‡ºå…¨å±æ—¶æ˜¾ç¤ºæç¤º
                showFullscreenPrompt();
            }
        });

        // 1. å¿ƒè·³å‡½æ•°
        async function sendHeartbeat() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/device/heartbeat/${DEVICE_ID}`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.name) {
                    const nameDisplay = document.getElementById('device-name-display');
                    if (nameDisplay) nameDisplay.textContent = `å½“å‰è®¾å¤‡: ${data.name}`;
                }
            } catch (error) {
                console.error('Heartbeat failed:', error);
            }
        }

        // 2. ä»»åŠ¡è½®è¯¢å‡½æ•°
        async function checkTask() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/device/check_task/${DEVICE_ID}`);
                const data = await response.json();

                if (data.task_available) {
                    const imageUrl = data.image_url;

                    // éšè—æ¬¢è¿æ¶ˆæ¯
                    welcomeMessage.style.display = 'none';

                    // é¢„åŠ è½½æ–°å›¾ç‰‡ï¼Œé¿å…é—ªé»‘
                    const newImg = new Image();
                    newImg.onload = () => {
                        // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œç›´æ¥åˆ‡æ¢
                        displayImage.src = imageUrl;
                        displayImage.style.display = 'block';
                        displayImage.style.opacity = 1;
                    };
                    newImg.onerror = () => {
                        console.error('Image load failed');
                        displayImage.style.display = 'none';
                        welcomeMessage.style.display = 'block';
                        welcomeMessage.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                    };
                    newImg.src = imageUrl;
                }
            } catch (error) {
                console.error('Check task failed:', error);
            }
        }

        // å¯åŠ¨å®¢æˆ·ç«¯
        function startClient() {
            // é¡µé¢åŠ è½½å3ç§’æ˜¾ç¤ºå…¨å±æç¤º
            setTimeout(() => {
                if (!document.fullscreenElement) {
                    showFullscreenPrompt();
                }
            }, 1500);

            // ç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³å’Œæ£€æŸ¥ä»»åŠ¡
            sendHeartbeat();
            checkTask();

            // å®šæ—¶å‘é€å¿ƒè·³
            setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);

            // å®šæ—¶è½®è¯¢ä»»åŠ¡
            setInterval(checkTask, POLLING_INTERVAL);
        }

        // å¯åŠ¨
        startClient();
    </script>
</body>

</html>